@page "/"
@using Telerik.ReportViewer.Blazor
@using DevCraftAspire.Web.Clients
@inject IJSRuntime JSRuntime
@inject ReportsApiClient ReportsApi

@* Important: prerender the ReportViewer *@
@rendermode InteractiveServer

@* Important: Viewer's resources are dynamically loaded in OnAfterRenderAsync because I don't know the base URL yet *@
<ReportViewer @ref="ReportViewer1"
              ViewerId="rv1"
              ServiceUrl="@ApiServiceUrl"
              ReportSource="@MyReportSource"
              ScaleMode="@(ScaleMode.Specific)"
              Scale="1.0" />

@code {
    private string? ApiServiceUrl { get; set; }
    private ReportViewer? ReportViewer1 { get; set; }
    private ReportSourceOptions MyReportSource { get; set; } = new() { Report = "Barcodes Report.trdp" };

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var rootUrl = "";
#if DEBUG
            rootUrl = "https://localhost:7443";
#elif RELEASE
            rootUrl = Environment.GetEnvironmentVariable("services__apiservice__https__0");
#endif

            await JSRuntime.InvokeVoidAsync("loadScript", $"{rootUrl}/reports");

            this.ApiServiceUrl = $"{rootUrl}/reports";
        }

        await base.OnAfterRenderAsync(firstRender);
    }
}